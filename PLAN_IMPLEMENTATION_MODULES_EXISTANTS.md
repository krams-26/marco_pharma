# Plan d'Impl√©mentation - Modules Existants Marco-Pharma

## üéØ ANALYSE COMPL√àTE : O√ô IMPL√âMENTER LES FONCTIONNALIT√âS

---

## ‚úÖ BONNE NOUVELLE : LA PLUPART DES STRUCTURES EXISTENT D√âJ√Ä!

### Modules et Tables Actuels:
1. ‚úÖ **ProductBatch** - Table existe (ligne 137 models.py)
2. ‚úÖ **StockMovement** - Table existe (ligne 263 models.py)
3. ‚úÖ **Audit** - Table existe (ligne 379 models.py)
4. ‚úÖ **TempSale** - Table existe! (ligne 665 models.py)
5. ‚úÖ **Routes Stock** - `app/routes/stock.py` existe
6. ‚úÖ **Routes Audits** - `app/routes/audits.py` existe
7. ‚úÖ **Routes Sales** - G√®re d√©j√† TempSale (lignes 309-410)

---

## üìã √âTAT ACTUEL VS FONCTIONNALIT√âS MANQUANTES

### 1Ô∏è‚É£ GESTION PAR LOTS (Stock Lots)

#### ‚úÖ CE QUI EXISTE D√âJ√Ä:

**Table `ProductBatch` (models.py:137-149)**:
```python
class ProductBatch(db.Model):
    id, product_id, batch_number, quantity, purchase_price
    expiry_date, received_date, supplier, is_active
```

**Routes Existantes** (`app/routes/stock.py`):
- `/stock/batches` - Liste des lots (ligne 121)
- `/stock/add-batch` - Ajouter lot (ligne 134)

**Templates Existants**:
- `app/templates/stock/batches.html` - Affichage lots
- `app/templates/stock/add_batch.html` - Formulaire ajout

#### ‚ùå CE QUI MANQUE:

1. **Champs Manquants dans ProductBatch**:
   - ‚ùå `pharmacy_id` (pour multi-pharmacies)
   - ‚ùå `initial_quantity` (quantit√© initiale)
   - ‚ùå `manufacture_date` (date fabrication)
   - ‚ùå `status` (active, expired, recalled, depleted)
   - ‚ùå `unit_cost` (co√ªt unitaire)

2. **Table `batch_movements` (Tra√ßabilit√© par lot)**:
   - ‚ùå Nouvelle table pour mouvements par lot
   - ‚ùå Types: entry, sale, transfer, adjustment, expiry
   - ‚ùå Lien avec lot_id, user_id, reference

3. **Fonctionnalit√©s Routes**:
   - ‚ùå √âdition de lot (`/stock/batches/<id>/edit`)
   - ‚ùå Vue d√©taill√©e lot (`/stock/batches/<id>`)
   - ‚ùå Historique par lot (`/stock/batches/<id>/movements`)
   - ‚ùå Alertes expiration (`/stock/batches/expiring`)
   - ‚ùå Export lots (`/stock/batches/export`)
   - ‚ùå S√©lection FEFO dans POS

4. **Templates Manquants**:
   - ‚ùå `stock/batch_view.html` - D√©tails + historique
   - ‚ùå `stock/batch_edit.html` - √âditer lot
   - ‚ùå `stock/batch_alerts.html` - Lots expirant
   - ‚ùå Am√©liorer `stock/batches.html` - Filtres, pagination, statuts

5. **Logique POS**:
   - ‚ùå S√©lection automatique FEFO lors de vente
   - ‚ùå D√©duction stock du bon lot
   - ‚ùå Blocage lots expir√©s

#### üìç O√ô IMPL√âMENTER:

**Fichiers √† Modifier**:
```
1. app/models.py (ligne 137-149)
   ‚û°Ô∏è Ajouter champs manquants √† ProductBatch
   ‚û°Ô∏è Cr√©er nouvelle classe BatchMovement

2. app/routes/stock.py
   ‚û°Ô∏è Enrichir route /batches (filtres, pagination)
   ‚û°Ô∏è Ajouter /batches/<id> (vue d√©taill√©e)
   ‚û°Ô∏è Ajouter /batches/<id>/edit
   ‚û°Ô∏è Ajouter /batches/<id>/movements
   ‚û°Ô∏è Ajouter /batches/expiring (alertes)
   ‚û°Ô∏è Ajouter /batches/export

3. app/routes/pos.py
   ‚û°Ô∏è Modifier logique vente (ligne 88-108)
   ‚û°Ô∏è Ajouter s√©lection FEFO automatique
   ‚û°Ô∏è D√©duire du bon lot

4. app/templates/stock/
   ‚û°Ô∏è Enrichir batches.html (filtres, statuts, actions)
   ‚û°Ô∏è Cr√©er batch_view.html
   ‚û°Ô∏è Cr√©er batch_edit.html
   ‚û°Ô∏è Cr√©er batch_alerts.html
```

---

### 2Ô∏è‚É£ MOUVEMENTS DE STOCK D√âTAILL√âS

#### ‚úÖ CE QUI EXISTE D√âJ√Ä:

**Table `StockMovement` (models.py:263-277)**:
```python
class StockMovement(db.Model):
    id, product_id, pharmacy_id, movement_type, quantity
    reference, notes, created_by, created_at
```

**Routes Existantes** (`app/routes/stock.py`):
- `/stock/` - Liste mouvements (ligne 12)
- `/stock/export/<format>` - Export (ligne 36)

**Template Existant**:
- `app/templates/stock/index.html` - Liste mouvements

#### ‚ùå CE QUI MANQUE:

1. **Champs Manquants dans StockMovement**:
   - ‚ùå `movement_subtype` (sale, transfer_in, transfer_out, adjustment_in, adjustment_out, return, loss, expiry)
   - ‚ùå `batch_id` (lien avec lot)
   - ‚ùå `from_pharmacy_id` (pour transferts)
   - ‚ùå `to_pharmacy_id` (pour transferts)
   - ‚ùå `unit_cost` (co√ªt unitaire)
   - ‚ùå `total_value` (valeur totale)
   - ‚ùå `reference_type` (sale, purchase, transfer, adjustment)
   - ‚ùå `reference_id` (ID r√©f√©rence)

2. **Fonctionnalit√©s Routes**:
   - ‚ùå Filtres avanc√©s (type, sous-type, p√©riode, utilisateur, produit, pharmacie)
   - ‚ùå Vue d√©taill√©e mouvement (`/stock/movements/<id>`)
   - ‚ùå Mouvements par produit (`/stock/movements/product/<id>`)
   - ‚ùå Mouvements par pharmacie (`/stock/movements/pharmacy/<id>`)
   - ‚ùå Mouvements par utilisateur (`/stock/movements/user/<id>`)
   - ‚ùå Statistiques mouvements (`/stock/movements/stats`)
   - ‚ùå Rapport valeur mouvements

3. **Templates Manquants**:
   - ‚ùå Enrichir `stock/index.html` (filtres avanc√©s, graphiques)
   - ‚ùå `stock/movement_view.html` - D√©tails mouvement
   - ‚ùå `stock/movements_stats.html` - Statistiques

4. **Enregistrements Automatiques**:
   - ‚ùå Lors ventes POS
   - ‚ùå Lors transferts
   - ‚ùå Lors ajustements
   - ‚ùå Lors retours

#### üìç O√ô IMPL√âMENTER:

**Fichiers √† Modifier**:
```
1. app/models.py (ligne 263-277)
   ‚û°Ô∏è Ajouter champs manquants √† StockMovement
   ‚û°Ô∏è Ajouter m√©thodes helper (get_by_product, get_by_pharmacy)

2. app/routes/stock.py (ligne 12-66)
   ‚û°Ô∏è Enrichir route / avec filtres avanc√©s
   ‚û°Ô∏è Ajouter /movements/<id>
   ‚û°Ô∏è Ajouter /movements/product/<id>
   ‚û°Ô∏è Ajouter /movements/pharmacy/<id>
   ‚û°Ô∏è Ajouter /movements/stats
   ‚û°Ô∏è Am√©liorer export avec plus de d√©tails

3. app/routes/pos.py, sales.py, stock.py
   ‚û°Ô∏è Enregistrer automatiquement mouvements d√©taill√©s

4. app/templates/stock/index.html
   ‚û°Ô∏è Ajouter filtres avanc√©s (datepicker, multi-select)
   ‚û°Ô∏è Ajouter graphiques (Chart.js)
   ‚û°Ô∏è Ajouter indicateurs (total entr√©es/sorties/valeur)

5. Cr√©er app/templates/stock/
   ‚û°Ô∏è movement_view.html
   ‚û°Ô∏è movements_stats.html
```

---

### 3Ô∏è‚É£ JOURNAL D'ACTIVIT√âS (Activity Log)

#### ‚úÖ CE QUI EXISTE D√âJ√Ä:

**Table `Audit` (models.py:379-390)**:
```python
class Audit(db.Model):
    id, user_id, action, details, ip_address, created_at
```

**Routes Existantes** (`app/routes/audits.py`):
- `/audits/` - Liste audits (ligne 11)
- Filtres: user_id, action, date_from, date_to

**Template Existant**:
- `app/templates/audits/index.html`

#### ‚ùå CE QUI MANQUE:

1. **Champs Manquants dans Audit**:
   - ‚ùå `module` (products, sales, users, stock, etc.)
   - ‚ùå `record_id` (ID enregistrement concern√©)
   - ‚ùå `action_type` (create, update, delete, view, export, login, logout)
   - ‚ùå `old_value` (valeur avant)
   - ‚ùå `new_value` (valeur apr√®s)
   - ‚ùå `result` (success, failed, denied)
   - ‚ùå `user_agent` (navigateur)
   - ‚ùå `session_id`

2. **Fonctionnalit√©s Routes**:
   - ‚ùå Filtres par module (`/audits?module=sales`)
   - ‚ùå Filtres par type action (`/audits?action_type=delete`)
   - ‚ùå Filtres par r√©sultat (`/audits?result=failed`)
   - ‚ùå Vue d√©taill√©e audit (`/audits/<id>`)
   - ‚ùå Dashboard activit√©s (`/audits/dashboard`)
   - ‚ùå Alertes actions suspectes (`/audits/alerts`)
   - ‚ùå Export d√©taill√©

3. **Helper Universel**:
   - ‚ùå Cr√©er `app/helpers/activity_logger.py`
   - ‚ùå Fonction `log_activity(action, module, details)`
   - ‚ùå Auto-capture IP, user_agent, session

4. **Int√©gration Partout**:
   - ‚ùå Dans TOUTES les routes (create, update, delete)
   - ‚ùå Dans auth (login, logout, failed attempts)
   - ‚ùå Dans exports
   - ‚ùå Dans validations
   - ‚ùå Dans acc√®s refus√© (403)

5. **Templates**:
   - ‚ùå Enrichir `audits/index.html` (filtres, graphiques, stats)
   - ‚ùå `audits/view.html` - D√©tails audit
   - ‚ùå `audits/dashboard.html` - Dashboard activit√©
   - ‚ùå `audits/alerts.html` - Activit√©s suspectes

#### üìç O√ô IMPL√âMENTER:

**Fichiers √† Modifier**:
```
1. app/models.py (ligne 379-390)
   ‚û°Ô∏è Ajouter champs manquants √† Audit
   ‚û°Ô∏è Renommer en ActivityLog si n√©cessaire

2. Cr√©er app/helpers/activity_logger.py (NOUVEAU)
   ‚û°Ô∏è Fonction log_activity()
   ‚û°Ô∏è Auto-capture contexte (IP, user, module)
   ‚û°Ô∏è Format JSON pour old_value/new_value

3. app/routes/audits.py
   ‚û°Ô∏è Enrichir route / avec filtres avanc√©s
   ‚û°Ô∏è Ajouter /audits/<id>
   ‚û°Ô∏è Ajouter /audits/dashboard
   ‚û°Ô∏è Ajouter /audits/alerts
   ‚û°Ô∏è Am√©liorer export

4. TOUTES les routes (products, sales, users, etc.)
   ‚û°Ô∏è Importer activity_logger
   ‚û°Ô∏è Ajouter log_activity() apr√®s chaque action
   ‚û°Ô∏è Capturer before/after pour updates

5. app/routes/auth.py
   ‚û°Ô∏è Logger login success/failed
   ‚û°Ô∏è Logger logout
   ‚û°Ô∏è Logger password reset

6. app/templates/audits/
   ‚û°Ô∏è Enrichir index.html (filtres module, type, r√©sultat)
   ‚û°Ô∏è Cr√©er view.html
   ‚û°Ô∏è Cr√©er dashboard.html (graphiques Chart.js)
   ‚û°Ô∏è Cr√©er alerts.html
```

---

### 4Ô∏è‚É£ VENTES TEMPORAIRES (Temp Sales)

#### ‚úÖ CE QUI EXISTE D√âJ√Ä! (SURPRISE!)

**Table `TempSale` (models.py:665-690)**:
```python
class TempSale(db.Model):
    id, reference, customer_id, created_by, pharmacy_id
    total_amount, discount, items_data, payment_method
    notes, status, validated_by, validated_at, sale_id
    rejection_reason, created_at, updated_at
```

**Logique Existante** (`app/routes/sales.py:309-410`):
- `validate_temp_sale(id)` - Valider vente temporaire
- `reject_temp_sale(id)` - Rejeter vente temporaire

**Logique POS** (`app/routes/pos.py:88-108`):
- Cr√©ation TempSale lors de vente

#### ‚ùå CE QUI MANQUE:

1. **Routes Manquantes**:
   - ‚ùå `/sales/temp` - Liste ventes temporaires
   - ‚ùå `/sales/temp/<id>` - Voir d√©tails
   - ‚ùå `/sales/temp/<id>/edit` - Modifier brouillon
   - ‚ùå `/sales/temp/<id>/resume` - Reprendre vente
   - ‚ùå `/sales/temp/<id>/delete` - Supprimer brouillon
   - ‚ùå `/sales/temp/export` - Export

2. **Fonctionnalit√©s POS**:
   - ‚ùå Bouton "Sauvegarder comme brouillon" dans POS
   - ‚ùå Bouton "Reprendre brouillon" dans POS
   - ‚ùå Liste des brouillons en cours
   - ‚ùå Auto-save toutes les 30 secondes

3. **Templates Manquants**:
   - ‚ùå `sales/temp_index.html` - Liste brouillons
   - ‚ùå `sales/temp_view.html` - D√©tails brouillon
   - ‚ùå Int√©grer dans `pos/index.html` - Section "Brouillons"

4. **Notifications**:
   - ‚ùå Notifier quand brouillon valid√©
   - ‚ùå Notifier quand brouillon rejet√©

#### üìç O√ô IMPL√âMENTER:

**Fichiers √† Modifier**:
```
1. app/routes/sales.py
   ‚û°Ô∏è Ajouter route /sales/temp (ligne ~33 utilise d√©j√† TempSale)
   ‚û°Ô∏è Ajouter /sales/temp/<id>
   ‚û°Ô∏è Ajouter /sales/temp/<id>/edit
   ‚û°Ô∏è Ajouter /sales/temp/<id>/resume
   ‚û°Ô∏è Ajouter /sales/temp/<id>/delete
   ‚û°Ô∏è Ajouter /sales/temp/export

2. app/routes/pos.py (ligne 88-108)
   ‚û°Ô∏è Ajouter endpoint /pos/save-draft
   ‚û°Ô∏è Ajouter endpoint /pos/load-draft/<id>
   ‚û°Ô∏è Ajouter endpoint /pos/list-drafts

3. app/templates/pos/index.html
   ‚û°Ô∏è Ajouter bouton "Sauvegarder brouillon"
   ‚û°Ô∏è Ajouter modal liste brouillons
   ‚û°Ô∏è Ajouter auto-save JS

4. Cr√©er app/templates/sales/
   ‚û°Ô∏è temp_index.html
   ‚û°Ô∏è temp_view.html

5. app/templates/includes/sidenav.html
   ‚û°Ô∏è Ajouter lien "Ventes Brouillons" dans menu Ventes
```

---

### 5Ô∏è‚É£ CONTACTS PROFESSIONNELS

#### ‚úÖ CE QUI EXISTE (PARTIELLEMENT):

**Module Suppliers** existe:
- Table `Supplier` (models.py:635-664)
- Routes `app/routes/suppliers.py`
- Templates `app/templates/suppliers/`

#### ‚ùå CE QUI MANQUE:

Cr√©er nouveau module **Contacts** s√©par√© ou enrichir **Suppliers**?

**Option 1: Enrichir Suppliers** (Plus simple):
1. ‚ùå Ajouter champs √† Supplier:
   - `contact_type` (supplier, partner, service_provider, other)
   - `primary_contact_name`
   - `primary_contact_phone`
   - `primary_contact_email`
   - `secondary_contact_name`
   - `secondary_contact_phone`
   - `website`
   - `tax_id`
   - `notes`

2. ‚ùå Enrichir routes suppliers avec filtres par type

**Option 2: Nouveau Module Contacts** (Plus complet):
1. ‚ùå Cr√©er table `Contact` dans models.py
2. ‚ùå Cr√©er `app/routes/contacts.py`
3. ‚ùå Cr√©er `app/templates/contacts/`

#### üìç O√ô IMPL√âMENTER:

**Option Recommand√©e: Enrichir Suppliers**
```
1. app/models.py (ligne 635-664)
   ‚û°Ô∏è Ajouter champs contact √† Supplier

2. app/routes/suppliers.py
   ‚û°Ô∏è Ajouter filtres par type
   ‚û°Ô∏è Am√©liorer formulaires

3. app/templates/suppliers/
   ‚û°Ô∏è Enrichir create.html et edit.html
   ‚û°Ô∏è Am√©liorer show.html avec infos contact
```

---

## üìä PRIORIT√âS D'IMPL√âMENTATION

### üî¥ PHASE 1 - CRITIQUE (Semaine 1-2):

#### 1. Gestion par Lots COMPL√àTE
**Dur√©e**: 2-3 jours
**Fichiers**:
- ‚úèÔ∏è Modifier `app/models.py` (ProductBatch + BatchMovement)
- ‚úèÔ∏è Enrichir `app/routes/stock.py` (6 nouvelles routes)
- ‚úèÔ∏è Modifier `app/routes/pos.py` (logique FEFO)
- ‚úèÔ∏è Am√©liorer templates `stock/batches*.html` (4 fichiers)

#### 2. Mouvements Stock D√©taill√©s
**Dur√©e**: 1-2 jours
**Fichiers**:
- ‚úèÔ∏è Modifier `app/models.py` (StockMovement)
- ‚úèÔ∏è Enrichir `app/routes/stock.py` (4 nouvelles routes)
- ‚úèÔ∏è Am√©liorer `stock/index.html`
- ‚úèÔ∏è Cr√©er `stock/movements_stats.html`

#### 3. Journal d'Activit√©s Complet
**Dur√©e**: 2 jours
**Fichiers**:
- ‚úèÔ∏è Modifier `app/models.py` (Audit)
- üÜï Cr√©er `app/helpers/activity_logger.py`
- ‚úèÔ∏è Enrichir `app/routes/audits.py`
- ‚úèÔ∏è Modifier TOUTES routes (ajouter logging)
- ‚úèÔ∏è Am√©liorer `audits/index.html`
- üÜï Cr√©er `audits/dashboard.html`

### üü° PHASE 2 - IMPORTANT (Semaine 3):

#### 4. Ventes Temporaires Interface
**Dur√©e**: 1 jour
**Fichiers**:
- ‚úèÔ∏è Enrichir `app/routes/sales.py` (5 routes)
- ‚úèÔ∏è Enrichir `app/routes/pos.py` (3 routes)
- ‚úèÔ∏è Modifier `pos/index.html` (boutons + modal)
- üÜï Cr√©er `sales/temp_index.html`
- üÜï Cr√©er `sales/temp_view.html`

#### 5. Contacts/Enrichir Suppliers
**Dur√©e**: 1 jour
**Fichiers**:
- ‚úèÔ∏è Enrichir `app/models.py` (Supplier)
- ‚úèÔ∏è Am√©liorer `app/routes/suppliers.py`
- ‚úèÔ∏è Am√©liorer templates `suppliers/*.html`

---

## üìù R√âSUM√â FICHIERS √Ä MODIFIER

### Fichiers Principaux:
```
‚úèÔ∏è MODIFIER:
1. app/models.py (5 mod√®les: ProductBatch, StockMovement, Audit, Supplier + 1 nouveau BatchMovement)
2. app/routes/stock.py (10 nouvelles routes)
3. app/routes/audits.py (4 nouvelles routes)
4. app/routes/sales.py (5 routes temp_sales)
5. app/routes/pos.py (logique FEFO + brouillons)
6. app/routes/suppliers.py (enrichir)
7. TOUTES routes/*.py (ajouter activity logging)

üÜï CR√âER:
8. app/helpers/activity_logger.py (NOUVEAU module)

‚úèÔ∏è TEMPLATES MODIFIER:
9. app/templates/stock/batches.html
10. app/templates/stock/index.html
11. app/templates/audits/index.html
12. app/templates/pos/index.html
13. app/templates/suppliers/*.html

üÜï TEMPLATES CR√âER:
14. app/templates/stock/batch_view.html
15. app/templates/stock/batch_edit.html
16. app/templates/stock/batch_alerts.html
17. app/templates/stock/movement_view.html
18. app/templates/stock/movements_stats.html
19. app/templates/audits/view.html
20. app/templates/audits/dashboard.html
21. app/templates/audits/alerts.html
22. app/templates/sales/temp_index.html
23. app/templates/sales/temp_view.html
```

---

## ‚úÖ CONCLUSION

**EXCELLENTE NOUVELLE**: Les structures de base existent d√©j√†!

### Ce qu'on a:
- ‚úÖ ProductBatch (√† enrichir)
- ‚úÖ StockMovement (√† enrichir)
- ‚úÖ Audit (√† enrichir)
- ‚úÖ TempSale (complet! Juste besoin UI)
- ‚úÖ Supplier (√† enrichir pour contacts)

### Ce qu'il faut:
- üìù Enrichir 5 mod√®les existants
- üìù Ajouter ~25 routes dans fichiers existants
- üÜï Cr√©er 1 helper (activity_logger)
- üìù Am√©liorer 6 templates existants
- üÜï Cr√©er 10 nouveaux templates

**Dur√©e Totale Estim√©e**: 5-7 jours de d√©veloppement

---

**Voulez-vous commencer par la Gestion par Lots (la plus critique)?**

¬© 2025 Marco Pharma | Plan d'Impl√©mentation Modules Existants

