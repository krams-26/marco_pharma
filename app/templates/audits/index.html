{% extends 'base.html' %}

{% block title %}Journal d'Audit{% endblock %}

{% block content %}

<!-- Header -->
<div class="header bg-gradient-info pb-6">
  <div class="container-fluid">
    <div class="header-body">
      <div class="row align-items-center py-4">
        <div class="col-lg-6">
          <h6 class="h2 text-white d-inline-block mb-0">
            <i class="fas fa-clipboard-list"></i> Journal d'Audit
          </h6>
          <nav aria-label="breadcrumb" class="d-none d-md-inline-block ml-md-4">
            <ol class="breadcrumb breadcrumb-links breadcrumb-dark">
              <li class="breadcrumb-item"><a href="{{ url_for('dashboard.index') }}"><i class="fas fa-home"></i></a></li>
              <li class="breadcrumb-item active">Audits</li>
            </ol>
          </nav>
        </div>
        <div class="col-lg-6 text-right">
          <a href="{{ url_for('audits.dashboard') }}" class="btn btn-sm btn-neutral">
            <i class="fas fa-chart-bar"></i> Dashboard
          </a>
          <a href="{{ url_for('audits.alerts') }}" class="btn btn-sm btn-warning">
            <i class="fas fa-exclamation-triangle"></i> Alertes
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Page content -->
<div class="container-fluid mt--6">
  <div class="row">
    <div class="col">
      <div class="card">
        <!-- Card header -->
        <div class="card-header border-0">
          <div class="row">
            <div class="col-md-6">
              <h3 class="mb-0">Historique des Activités</h3>
            </div>
            <div class="col-md-6 text-right">
              <a href="{{ url_for('audits.export', format='excel', **filters) }}" class="btn btn-sm btn-success">
                <i class="fas fa-file-excel"></i> Excel
              </a>
              <a href="{{ url_for('audits.export', format='csv', **filters) }}" class="btn btn-sm btn-info">
                <i class="fas fa-file-csv"></i> CSV
              </a>
            </div>
          </div>
        </div>

        <!-- Filtres avancés -->
        <div class="card-body bg-secondary">
          <form method="get" class="row">
            <div class="col-md-2 form-group">
              <label class="form-control-label">Recherche</label>
              <input type="text" name="search" class="form-control form-control-sm" 
                     placeholder="Action, détails..." value="{{ filters.search or '' }}">
            </div>
            <div class="col-md-2 form-group">
              <label class="form-control-label">Utilisateur</label>
              <select name="user_id" class="form-control form-control-sm">
                <option value="">Tous</option>
                {% for user in users %}
                <option value="{{ user.id }}" {% if filters.user_id == user.id|string %}selected{% endif %}>
                  {{ user.username }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2 form-group">
              <label class="form-control-label">Module</label>
              <select name="module" class="form-control form-control-sm">
                <option value="all">Tous</option>
                {% for mod in modules %}
                <option value="{{ mod }}" {% if filters.module == mod %}selected{% endif %}>
                  {{ mod.capitalize() }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2 form-group">
              <label class="form-control-label">Type</label>
              <select name="action_type" class="form-control form-control-sm">
                <option value="all">Tous</option>
                {% for type in action_types %}
                <option value="{{ type }}" {% if filters.action_type == type %}selected{% endif %}>
                  {{ type.capitalize() }}
                </option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-2 form-group">
              <label class="form-control-label">Résultat</label>
              <select name="result" class="form-control form-control-sm">
                <option value="all">Tous</option>
                <option value="success" {% if filters.result == 'success' %}selected{% endif %}>Succès</option>
                <option value="failed" {% if filters.result == 'failed' %}selected{% endif %}>Échec</option>
                <option value="denied" {% if filters.result == 'denied' %}selected{% endif %}>Refusé</option>
              </select>
            </div>
            <div class="col-md-2 form-group d-flex align-items-end">
              <button type="submit" class="btn btn-primary btn-sm mr-2">
                <i class="fas fa-search"></i> Filtrer
                </button>
              <a href="{{ url_for('audits.index') }}" class="btn btn-secondary btn-sm">
                <i class="fas fa-redo"></i>
              </a>
            </div>
            <div class="col-md-3 form-group">
              <label class="form-control-label">Date Début</label>
              <input type="date" name="date_from" class="form-control form-control-sm" value="{{ filters.date_from or '' }}">
            </div>
            <div class="col-md-3 form-group">
              <label class="form-control-label">Date Fin</label>
              <input type="date" name="date_to" class="form-control form-control-sm" value="{{ filters.date_to or '' }}">
            </div>
        </form>
</div>

        <!-- Table -->
        <div class="table-responsive">
          <table class="table align-items-center table-flush">
            <thead class="thead-light">
                    <tr>
                <th>Date/Heure</th>
                        <th>Utilisateur</th>
                <th>Module</th>
                        <th>Action</th>
                <th>Type</th>
                        <th>Détails</th>
                <th>Résultat</th>
                        <th>IP</th>
                <th class="text-right">Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for audit in audits.items %}
              <tr {% if audit.is_suspicious %}class="table-warning"{% endif %}>
                <td>
                  <strong>{{ audit.created_at.strftime('%d/%m/%Y') }}</strong>
                  <br>
                  <small class="text-muted">{{ audit.created_at.strftime('%H:%M:%S') }}</small>
                </td>
                <td>
                  <span class="font-weight-bold">
                    {% if audit.user %}
                      {{ audit.user.username }}
                      <br><small class="text-muted">{{ audit.user.role }}</small>
                    {% else %}
                      Système
                    {% endif %}
                  </span>
                </td>
                <td>
                  {% if audit.module %}
                    <span class="badge badge-pill badge-info">{{ audit.module }}</span>
                  {% else %}
                    <span class="text-muted">-</span>
                  {% endif %}
                </td>
                <td>
                  <span class="badge badge-primary">{{ audit.action }}</span>
                </td>
                <td>
                  {% if audit.action_type == 'create' %}
                    <span class="badge badge-success"><i class="fas fa-plus"></i> Create</span>
                  {% elif audit.action_type == 'update' %}
                    <span class="badge badge-warning"><i class="fas fa-edit"></i> Update</span>
                  {% elif audit.action_type == 'delete' %}
                    <span class="badge badge-danger"><i class="fas fa-trash"></i> Delete</span>
                  {% elif audit.action_type == 'view' %}
                    <span class="badge badge-info"><i class="fas fa-eye"></i> View</span>
                  {% elif audit.action_type == 'export' %}
                    <span class="badge badge-secondary"><i class="fas fa-download"></i> Export</span>
                  {% elif audit.action_type == 'login' %}
                    <span class="badge badge-primary"><i class="fas fa-sign-in-alt"></i> Login</span>
                  {% elif audit.action_type == 'logout' %}
                    <span class="badge badge-secondary"><i class="fas fa-sign-out-alt"></i> Logout</span>
                  {% else %}
                    <span class="badge badge-light">{{ audit.action_type or '-' }}</span>
                  {% endif %}
                </td>
                <td><small>{{ (audit.details[:50] + '...') if audit.details and audit.details|length > 50 else (audit.details or '-') }}</small></td>
                <td>
                  {% if audit.result == 'success' %}
                    <span class="badge badge-success"><i class="fas fa-check"></i> Succès</span>
                  {% elif audit.result == 'failed' %}
                    <span class="badge badge-danger"><i class="fas fa-times"></i> Échec</span>
                  {% elif audit.result == 'denied' %}
                    <span class="badge badge-warning"><i class="fas fa-ban"></i> Refusé</span>
                            {% else %}
                    <span class="badge badge-light">{{ audit.result }}</span>
                            {% endif %}
                        </td>
                <td><span class="badge badge-pill badge-secondary">{{ audit.ip_address or '-' }}</span></td>
                <td class="text-right">
                  <a href="{{ url_for('audits.view', id=audit.id) }}" class="btn btn-sm btn-icon-only text-primary">
                    <i class="fas fa-eye"></i>
                  </a>
                </td>
                    </tr>
                    {% else %}
                    <tr>
                <td colspan="9" class="text-center text-muted py-5">
                  <i class="fas fa-inbox fa-3x mb-3"></i>
                  <p>Aucun audit trouvé</p>
                </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        
        <!-- Pagination -->
        {% if audits.pages > 1 %}
        <div class="card-footer py-4">
        <nav>
            <ul class="pagination justify-content-end mb-0">
              <li class="page-item {% if not audits.has_prev %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('audits.index', page=audits.prev_num, **filters) }}">
                  <i class="fas fa-angle-left"></i>
                </a>
              </li>
                {% for page_num in audits.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                    {% if page_num %}
                  <li class="page-item {% if page_num == audits.page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('audits.index', page=page_num, **filters) }}">{{ page_num }}</a>
                  </li>
                        {% else %}
                  <li class="page-item disabled"><span class="page-link">...</span></li>
                {% endif %}
              {% endfor %}
              <li class="page-item {% if not audits.has_next %}disabled{% endif %}">
                <a class="page-link" href="{{ url_for('audits.index', page=audits.next_num, **filters) }}">
                  <i class="fas fa-angle-right"></i>
                </a>
              </li>
            </ul>
        </nav>
        </div>
        {% endif %}
      </div>
    </div>
    </div>
</div>

{% endblock %}
