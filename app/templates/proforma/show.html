{% extends "base.html" %}

{% block title %}Facture Pro Forma {{ proforma.proforma_number }} - MARCO PHARMA{% endblock %}

{% block extra_css %}
<style>
@media print {
    .no-print { display: none !important; }
    body { background: white; }
    .main-wrapper { margin-left: 0 !important; }
    .main-content { padding: 15px !important; }
    .card { box-shadow: none !important; border: 1px solid #000 !important; }
    .top-header, .sidebar { display: none !important; }
}

.invoice-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 2rem;
    border-radius: 12px 12px 0 0;
}

.client-section {
    background: #f8f9fa;
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
}

.total-section {
    background: #e9ecef;
    padding: 1.5rem;
    border-radius: 8px;
}

.status-badge {
    padding: 0.5rem 1rem;
    border-radius: 20px;
    font-weight: bold;
}

.status-draft { background: #ffc107; color: #000; }
.status-sent { background: #17a2b8; color: white; }
.status-accepted { background: #28a745; color: white; }
.status-rejected { background: #dc3545; color: white; }
.status-expired { background: #6c757d; color: white; }
</style>
{% endblock %}

{% block content %}
<div class="invoice-container">
    <!-- En-tête -->
    <div class="card mb-4">
        <div class="invoice-header">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h1 class="mb-0">
                        <i class="fas fa-file-invoice"></i> Facture Pro Forma
                    </h1>
                    <p class="mb-0 mt-2">MARCO PHARMA</p>
                    <small>{{ proforma.user.full_name if proforma.user else 'Système' }}</small>
                </div>
                <div class="col-md-6 text-end">
                    <h3 class="mb-0">{{ proforma.proforma_number }}</h3>
                    <p class="mb-0">Émission: {{ proforma.issue_date.strftime('%d/%m/%Y') }}</p>
                    <p class="mb-0">Valide jusqu'au: {{ proforma.validity_date.strftime('%d/%m/%Y') }}</p>
                    <span class="status-badge status-{{ proforma.status }}">
                        {{ proforma.status|upper }}
                    </span>
                </div>
            </div>
        </div>
        
        <div class="card-body">
            <!-- Client -->
            <div class="client-section">
                <h5><i class="fas fa-user-circle"></i> Informations Client</h5>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Nom:</strong> {{ proforma.customer_name }}</p>
                        <p class="mb-1"><strong>Adresse:</strong> {{ proforma.customer_address or 'N/A' }}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Téléphone:</strong> {{ proforma.customer_phone or 'N/A' }}</p>
                        <p class="mb-1"><strong>Email:</strong> {{ proforma.customer_email or 'N/A' }}</p>
                    </div>
                </div>
            </div>
            
            <!-- Produits -->
            <h5><i class="fas fa-list-ul"></i> Détails des Produits</h5>
            <div class="table-responsive">
                <table class="table table-bordered">
                    <thead>
                        <tr>
                            <th>Produit</th>
                            <th>Code</th>
                            <th class="text-center">Qté Demandée</th>
                            <th class="text-center">Stock Dispo</th>
                            <th class="text-end">Prix Unit. HT</th>
                            <th class="text-end">Total HT</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for item in proforma.items %}
                        <tr>
                            <td>
                                <strong>{{ item.product_name }}</strong>
                                {% if item.line_notes %}
                                <br><small class="text-muted">{{ item.line_notes }}</small>
                                {% endif %}
                            </td>
                            <td>{{ item.product_code or '-' }}</td>
                            <td class="text-center">{{ item.quantity_requested }}</td>
                            <td class="text-center">
                                <span class="badge {{ 'bg-success' if item.stock_available >= item.quantity_requested else 'bg-warning' }}">
                                    {{ item.stock_available }}
                                </span>
                            </td>
                            <td class="text-end price-dual">
                                ${{ "%.2f"|format(item.unit_price) }}
                                <small class="text-muted d-block">{{ (item.unit_price|usd_to_cdf)|format_number }} FC</small>
                            </td>
                            <td class="text-end price-dual">
                                <strong>${{ "%.2f"|format(item.line_total) }}</strong>
                                <small class="text-muted d-block">{{ (item.line_total|usd_to_cdf)|format_number }} FC</small>
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            
            <!-- Totaux -->
            <div class="total-section">
                <div class="row">
                    <div class="col-md-6 offset-md-6">
                        <div class="d-flex justify-content-between mb-2">
                            <span>Total HT:</span>
                            <span class="price-dual">
                                <strong>${{ "%.2f"|format(proforma.total_ht) }}</strong>
                                <small class="text-muted d-block">{{ (proforma.total_ht|usd_to_cdf)|format_number }} FC</small>
                            </span>
                        </div>
                        <div class="d-flex justify-content-between mb-2">
                            <span>TVA (16%):</span>
                            <span class="price-dual">
                                <strong>${{ "%.2f"|format(proforma.total_tax) }}</strong>
                                <small class="text-muted d-block">{{ (proforma.total_tax|usd_to_cdf)|format_number }} FC</small>
                            </span>
                        </div>
                        <hr>
                        <div class="d-flex justify-content-between">
                            <span class="fs-5 fw-bold">TOTAL TTC:</span>
                            <span class="price-dual">
                                <strong class="fs-4 text-primary">${{ "%.2f"|format(proforma.total_ttc) }}</strong>
                                <small class="text-muted d-block"><strong>{{ (proforma.total_ttc|usd_to_cdf)|format_number }} FC</strong></small>
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Conditions -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <h6><i class="fas fa-credit-card"></i> Conditions de Paiement</h6>
                    <p class="text-muted">{{ proforma.payment_conditions }}</p>
                </div>
                <div class="col-md-6">
                    <h6><i class="fas fa-truck"></i> Conditions de Livraison</h6>
                    <p class="text-muted">{{ proforma.delivery_conditions }}</p>
                </div>
            </div>
            
            {% if proforma.notes %}
            <div class="mt-3">
                <h6><i class="fas fa-sticky-note"></i> Notes</h6>
                <p class="text-muted">{{ proforma.notes }}</p>
            </div>
            {% endif %}
            
            <!-- Actions -->
            <div class="text-center mt-4 no-print">
                <a href="{{ url_for('proforma.print', id=proforma.id) }}" class="btn btn-success" target="_blank">
                    <i class="fas fa-print"></i> Imprimer
                </a>
                <a href="{{ url_for('proforma.edit', id=proforma.id) }}" class="btn btn-primary">
                    <i class="fas fa-edit"></i> Modifier
                </a>
                <a href="{{ url_for('proforma.index') }}" class="btn btn-secondary">
                    <i class="fas fa-arrow-left"></i> Retour
                </a>
                
                {% if proforma.status == 'draft' %}
                <form method="POST" action="{{ url_for('proforma.send', id=proforma.id) }}" class="d-inline">
                    <button type="submit" class="btn btn-info">
                        <i class="fas fa-paper-plane"></i> Envoyer au client
                    </button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<p class="text-center text-muted mt-3 no-print">
    <small>Document généré le {{ "now"|format_datetime }} par {{ current_user.full_name }}</small>
</p>
{% endblock %}
